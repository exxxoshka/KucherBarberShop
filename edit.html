<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- –ù–∞—à–∏ —Å–∫—Ä–∏–ø—Ç—ã -->
    <script src="firebase-config.js"></script>
    
    <style>
        body {
            background: #f8f9fa;
        }
        .form-container {
            max-width: 800px;
            margin: 30px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞–ø–∏—Å—è–º</a>
            <span class="navbar-text">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏</span>
        </div>
    </nav>
    
    <div class="container">
        <div class="form-container">
            <h2 class="mb-4">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</h2>
            
            <form id="editForm" onsubmit="return false;">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞ *</label>
                        <input type="text" id="clientName" class="form-control" required placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                        <input type="tel" id="phone" class="form-control" required placeholder="+7 (999) 123-45-67">
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">–î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏ *</label>
                        <input type="date" id="date" class="form-control" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">–í—Ä–µ–º—è *</label>
                        <input type="time" id="time" class="form-control" required>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">–£—Å–ª—É–≥–∞ *</label>
                        <select id="service" class="form-control" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</option>
                            <option value="–ú—É–∂—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞">–ú—É–∂—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞</option>
                            <option value="–ñ–µ–Ω—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞">–ñ–µ–Ω—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞</option>
                            <option value="–ë—Ä–∏—Ç—å–µ">–ë—Ä–∏—Ç—å–µ</option>
                            <option value="–û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ">–û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ</option>
                            <option value="–£–∫–ª–∞–¥–∫–∞">–£–∫–ª–∞–¥–∫–∞</option>
                            <option value="–°—Ç—Ä–∏–∂–∫–∞+–ë—Ä–∏—Ç—å–µ">–°—Ç—Ä–∏–∂–∫–∞+–ë—Ä–∏—Ç—å–µ</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">–¶–µ–Ω–∞ (‚ÇΩ) *</label>
                        <input type="number" id="price" class="form-control" required min="0" value="1000">
                    </div>
                    
                    <div class="col-12">
                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-warning" onclick="updateAppointment()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                            <a href="dashboard.html" class="btn btn-secondary">‚ùå –û—Ç–º–µ–Ω–∞</a>
                            <button type="button" class="btn btn-danger ms-auto" onclick="deleteCurrentAppointment()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                        </div>
                    </div>
                </div>
            </form>
            
            <div id="message" class="mt-3"></div>
        </div>
    </div>
    
    <script>
        // –ü–æ–ª—É—á–∞–µ–º ID –∑–∞–ø–∏—Å–∏ –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const appointmentId = urlParams.get('id');
        
        let currentAppointmentId = appointmentId;
        
        // –ú–∞—Å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 1) {
                value = '+7 (' + value.substring(1, 4) + ') ' + 
                        value.substring(4, 7) + '-' + 
                        value.substring(7, 9) + '-' + 
                        value.substring(9, 11);
            }
            e.target.value = value.substring(0, 18);
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            
            if (!appointmentId) {
                showMessage('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID –∑–∞–ø–∏—Å–∏', 'danger');
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
            loadAppointmentData(appointmentId, user.uid);
        });
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
        function loadAppointmentData(id, userId) {
            db.collection('appointments').doc(id).get()
                .then(doc => {
                    if (!doc.exists) {
                        showMessage('–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'danger');
                        return;
                    }
                    
                    const data = doc.data();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø–∏—Å—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    if (data.userId !== userId) {
                        showMessage('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏', 'danger');
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 2000);
                        return;
                    }
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏
                    document.getElementById('clientName').value = data.clientName || '';
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
                    let phone = data.phone || '';
                    if (phone && phone.length === 11) {
                        phone = '+7 (' + phone.substring(1, 4) + ') ' + 
                                phone.substring(4, 7) + '-' + 
                                phone.substring(7, 9) + '-' + 
                                phone.substring(9, 11);
                    }
                    document.getElementById('phone').value = phone;
                    
                    document.getElementById('date').value = data.date || '';
                    document.getElementById('time').value = data.time || '';
                    document.getElementById('service').value = data.service || '';
                    document.getElementById('price').value = data.price || 1000;
                    
                })
                .catch(error => {
                    showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'danger');
                });
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
        function updateAppointment() {
            const user = auth.currentUser;
            if (!user || !currentAppointmentId) return;
            
            const clientName = document.getElementById('clientName').value.trim();
            const phone = document.getElementById('phone').value;
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const service = document.getElementById('service').value;
            const price = parseInt(document.getElementById('price').value);
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!clientName || !phone || !date || !time || !service || !price) {
                showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'danger');
                return;
            }
            
            // –û—á–∏—Å—Ç–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const cleanPhone = phone.replace(/\D/g, '');
            
            const updatedData = {
                clientName: clientName,
                phone: cleanPhone,
                date: date,
                time: time,
                service: service,
                price: price,
                updatedAt: new Date().toISOString()
            };
            
            db.collection('appointments').doc(currentAppointmentId).update(updatedData)
                .then(() => {
                    showMessage('‚úÖ –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!', 'success');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1500);
                })
                .catch(error => {
                    showMessage('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'danger');
                });
        }
        
        // –£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å
        function deleteCurrentAppointment() {
            if (!currentAppointmentId) return;
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
                db.collection('appointments').doc(currentAppointmentId).delete()
                    .then(() => {
                        showMessage('‚úÖ –ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞!', 'success');
                        setTimeout(() => {
                            window.location.href = 'dashboard.html';
                        }, 1500);
                    })
                    .catch(error => {
                        showMessage('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message, 'danger');
                    });
            }
        }
        
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${text}
                    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                </div>
            `;
        }
        
        // –£—Å—Ç–∞–Ω–æ–≤–∏–º –∑–∞–≤—Ç—Ä–∞—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        if (!document.getElementById('date').value) {
            document.getElementById('date').value = tomorrow.toISOString().split('T')[0];
        }
    </script>
</body>
</html>