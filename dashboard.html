<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä–∞</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: bold;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .card-header {
            background: white;
            border-bottom: 1px solid #eee;
            padding: 1rem 1.5rem;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 0.5rem 1.5rem;
        }
        
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            border-bottom: 3px solid #0d6efd;
            background: transparent;
        }
        
        .table th {
            border-top: none;
            font-weight: 600;
            color: #495057;
            background: #f8f9fa;
        }
        
        .badge {
            padding: 5px 10px;
            font-weight: 500;
        }
        
        .btn-sm {
            padding: 3px 8px;
            font-size: 12px;
        }
        
        .search-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 14px;
            }
            
            .btn {
                padding: 5px 8px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <span>üíà</span> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            </a>
            <div class="navbar-nav ms-auto">
                <span class="nav-link" id="userEmail"></span>
                <a class="nav-link" href="add.html" style="color: #0d6efd;">‚ûï –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</a>
                <a class="nav-link" href="booking.html" style="color: #20c997;">üåê –û–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å</a>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </div>
    </nav>
    
    <div class="container mt-4">
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="alerts"></div>
        
        <h2 class="mb-4">üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—è–º–∏</h2>
        
        <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <div class="search-box">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" id="searchInput" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏...">
                </div>
                <div class="col-md-3">
                    <input type="date" id="dateFilter" class="form-control">
                </div>
                <div class="col-md-3">
                    <select id="statusFilter" class="form-control">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="pending">–û–∂–∏–¥–∞–Ω–∏–µ</option>
                        <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</option>
                        <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                        <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="loadAppointments()">üîç –ü–æ–∏—Å–∫</button>
                </div>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="myTab">
                    <li class="nav-item">
                        <button class="nav-link active" id="all-tab" onclick="showTab('all')">
                            –í—Å–µ –∑–∞–ø–∏—Å–∏
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="admin-tab" onclick="showTab('admin')">
                            üë®‚Äçüíº –ú–æ–∏ –∑–∞–ø–∏—Å–∏
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="client-tab" onclick="showTab('client')">
                            üåê –û–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <!-- –í—Å–µ –∑–∞–ø–∏—Å–∏ -->
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="all-tab-content">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                        <th>–î–∞—Ç–∞</th>
                                        <th>–í—Ä–µ–º—è</th>
                                        <th>–£—Å–ª—É–≥–∞</th>
                                        <th>–¶–µ–Ω–∞</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–¢–∏–ø</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="allAppointmentsTable">
                                    <!-- –í—Å–µ –∑–∞–ø–∏—Å–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- –ó–∞–ø–∏—Å–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
                    <div class="tab-pane fade" id="admin-tab-content">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                        <th>–î–∞—Ç–∞</th>
                                        <th>–í—Ä–µ–º—è</th>
                                        <th>–£—Å–ª—É–≥–∞</th>
                                        <th>–¶–µ–Ω–∞</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="adminAppointmentsTable">
                                    <!-- –ó–∞–ø–∏—Å–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- –û–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
                    <div class="tab-pane fade" id="client-tab-content">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                        <th>–î–∞—Ç–∞</th>
                                        <th>–í—Ä–µ–º—è</th>
                                        <th>–£—Å–ª—É–≥–∞</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–ó–∞–ø–∏—Å–∞–Ω–æ</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="clientAppointmentsTable">
                                    <!-- –û–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body">
                        <h5 class="card-title">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</h5>
                        <h2 id="totalCount" class="card-text">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body">
                        <h5 class="card-title">–û–∂–∏–¥–∞–Ω–∏–µ</h5>
                        <h2 id="pendingCount" class="card-text">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body">
                        <h5 class="card-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</h5>
                        <h2 id="confirmedCount" class="card-text">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body">
                        <h5 class="card-title">–û–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏</h5>
                        <h2 id="onlineCount" class="card-text">0</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script>
        // ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyDwXOEGv2GBkeWggfhcBnfKQWnHDVeI890",
            authDomain: "barber-salon-cucher.firebaseapp.com",
            projectId: "barber-salon-cucher",
            storageBucket: "barber-salon-cucher.firebasestorage.app",
            messagingSenderId: "337468108878",
            appId: "1:337468108878:web:0fbcb5f537d891cd2ed31f"
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // ===== –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
        let currentTab = 'all';
        let currentUserId = null;
        
        // ===== –ü–†–û–í–ï–†–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò =====
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                currentUserId = user.uid;
                document.getElementById('userEmail').textContent = user.email;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–ø–∏—Å–∏
                loadAppointments();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏
                checkNewOnlineBookings();
            }
        });
        
        // ===== –ó–ê–ì–†–£–ó–ö–ê –í–°–ï–• –ó–ê–ü–ò–°–ï–ô =====
        async function loadAppointments() {
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–∏—Å–µ–π...');
            
            const search = document.getElementById('searchInput').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï –∑–∞–ø–∏—Å–∏
                const snapshot = await db.collection('appointments')
                    .orderBy('created_at', 'desc')
                    .get();
                
                console.log('–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π:', snapshot.size);
                
                // –°—á–µ—Ç—á–∏–∫–∏
                let total = 0;
                let pending = 0;
                let confirmed = 0;
                let online = 0;
                
                // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                const allAppointments = [];
                const adminAppointments = [];
                const clientAppointments = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    // –ü—Ä–∏–≤–æ–¥–∏–º –ø–æ–ª—è –∫ –µ–¥–∏–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É
                    const appointment = {
                        id: id,
                        clientName: data.clientName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        phone: data.phone || '',
                        date: data.appointment_date || data.date || '',
                        time: data.appointment_time || data.time || '',
                        service: data.service || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        price: data.price || 0,
                        status: data.status || 'pending',
                        type: data.type || 'admin',
                        createdAt: data.created_at || '',
                        userId: data.user_id || null
                    };
                    
                    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
                    let include = true;
                    
                    if (search && !appointment.clientName.toLowerCase().includes(search)) {
                        include = false;
                    }
                    
                    if (dateFilter && appointment.date !== dateFilter) {
                        include = false;
                    }
                    
                    if (statusFilter && appointment.status !== statusFilter) {
                        include = false;
                    }
                    
                    if (include) {
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫
                        allAppointments.push(appointment);
                        total++;
                        
                        // –°—á–µ—Ç—á–∏–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤
                        if (appointment.status === 'pending') pending++;
                        if (appointment.status === 'confirmed') confirmed++;
                        if (appointment.type === 'client') online++;
                        
                        // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ —Ç–∏–ø–∞–º
                        if (appointment.type === 'admin') {
                            adminAppointments.push(appointment);
                        } else if (appointment.type === 'client') {
                            clientAppointments.push(appointment);
                        }
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã
                renderTable('allAppointmentsTable', allAppointments);
                renderTable('adminAppointmentsTable', adminAppointments);
                renderTable('clientAppointmentsTable', clientAppointments);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                document.getElementById('totalCount').textContent = total;
                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('confirmedCount').textContent = confirmed;
                document.getElementById('onlineCount').textContent = online;
                
                console.log('–ó–∞–ø–∏—Å–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', { total, pending, confirmed, online });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π: ' + error.message, 'danger');
            }
        }
        
        // ===== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ =====
        function renderTable(tableId, appointments) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            if (appointments.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <div class="py-3">
                                <div style="font-size: 3rem;">üì≠</div>
                                <p class="mt-2">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            appointments.forEach(appointment => {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É —Ç–∏–ø–∞
                const typeIcon = appointment.type === 'client' ? 'üåê' : 'üë®‚Äçüíº';
                const typeText = appointment.type === 'client' ? '–û–Ω–ª–∞–π–Ω' : '–ê–¥–º–∏–Ω';
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞
                let statusClass = 'secondary';
                let statusText = '–ù–µ —É–∫–∞–∑–∞–Ω';
                
                switch (appointment.status) {
                    case 'pending':
                        statusClass = 'warning';
                        statusText = '–û–∂–∏–¥–∞–Ω–∏–µ';
                        break;
                    case 'confirmed':
                        statusClass = 'success';
                        statusText = '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ';
                        break;
                    case 'completed':
                        statusClass = 'info';
                        statusText = '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
                        break;
                    case 'cancelled':
                        statusClass = 'danger';
                        statusText = '–û—Ç–º–µ–Ω–µ–Ω–æ';
                        break;
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
                const phone = formatPhone(appointment.phone);
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è
                let createdText = '';
                if (appointment.createdAt) {
                    const createdDate = new Date(appointment.createdAt);
                    createdText = createdDate.toLocaleDateString('ru-RU');
                }
                
                // –î–µ–π—Å—Ç–≤–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–ø–∏—Å–∏
                let actions = '';
                
                if (appointment.type === 'client') {
                    // –î–ª—è –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–µ–π
                    actions = `
                        <button onclick="changeStatus('${appointment.id}', 'confirmed')" 
                                class="btn btn-sm btn-success" title="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å">
                            ‚úÖ
                        </button>
                        <button onclick="changeStatus('${appointment.id}', 'completed')" 
                                class="btn btn-sm btn-info" title="–í—ã–ø–æ–ª–Ω–µ–Ω–æ">
                            ‚úì
                        </button>
                        <button onclick="changeStatus('${appointment.id}', 'cancelled')" 
                                class="btn btn-sm btn-danger" title="–û—Ç–º–µ–Ω–∏—Ç—å">
                            ‚ùå
                        </button>
                    `;
                } else {
                    // –î–ª—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π
                    actions = `
                        <a href="edit.html?id=${appointment.id}" 
                           class="btn btn-sm btn-warning" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            ‚úèÔ∏è
                        </a>
                        <button onclick="deleteAppointment('${appointment.id}')" 
                                class="btn btn-sm btn-danger" title="–£–¥–∞–ª–∏—Ç—å">
                            üóëÔ∏è
                        </button>
                    `;
                }
                
                // –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
                html += `
                    <tr>
                        <td>
                            ${escapeHtml(appointment.clientName)}
                            <br>
                            <small class="text-muted">${typeIcon} ${typeText}</small>
                        </td>
                        <td>${phone}</td>
                        <td>${appointment.date}</td>
                        <td>${appointment.time}</td>
                        <td>${escapeHtml(appointment.service)}</td>
                        ${tableId === 'clientAppointmentsTable' ? '' : `<td>${appointment.price} ‚ÇΩ</td>`}
                        <td>
                            <span class="badge bg-${statusClass}">${statusText}</span>
                        </td>
                        ${tableId === 'clientAppointmentsTable' ? 
                          `<td><small>${createdText}</small></td>` : 
                          `<td><small>${typeText}</small></td>`}
                        <td>
                            ${actions}
                        </td>
                    </tr>
                `;
            });
            
            table.innerHTML = html;
        }
        
        // ===== –°–ú–ï–ù–ê –°–¢–ê–¢–£–°–ê =====
        async function changeStatus(id, newStatus) {
            const statusTexts = {
                'confirmed': '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞',
                'completed': '–æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è',
                'cancelled': '–æ—Ç–º–µ–Ω–µ–Ω–∞'
            };
            
            const text = statusTexts[newStatus] || '–∏–∑–º–µ–Ω–µ–Ω–∞';
            
            if (!confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏ –Ω–∞ "${text}"?`)) return;
            
            try {
                await db.collection('appointments').doc(id).update({
                    status: newStatus,
                    updated_at: new Date().toISOString()
                });
                
                showAlert(`‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏ ${text}`, 'success');
                loadAppointments();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
                showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'danger');
            }
        }
        
        // ===== –£–î–ê–õ–ï–ù–ò–ï –ó–ê–ü–ò–°–ò =====
        async function deleteAppointment(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
            
            try {
                await db.collection('appointments').doc(id).delete();
                showAlert('‚úÖ –ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞', 'success');
                loadAppointments();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                showAlert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message, 'danger');
            }
        }
        
        // ===== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–ö–õ–ê–î–û–ö =====
        function showTab(tabName) {
            currentTab = tabName;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('#myTab .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('show', 'active');
            });
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.getElementById(`${tabName}-tab-content`).classList.add('show', 'active');
            
            // –ï—Å–ª–∏ —ç—Ç–æ –≤–∫–ª–∞–¥–∫–∞ –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–µ–π, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ
            if (tabName === 'client') {
                markOnlineAsViewed();
            }
        }
        
        // ===== –ü–†–û–í–ï–†–ö–ê –ù–û–í–´–• –û–ù–õ–ê–ô–ù-–ó–ê–ü–ò–°–ï–ô =====
        async function checkNewOnlineBookings() {
            try {
                // –ò—â–µ–º –Ω–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏
                const snapshot = await db.collection('appointments')
                    .where('type', '==', 'client')
                    .where('admin_viewed', '==', false)
                    .get();
                
                if (!snapshot.empty) {
                    showNotification(`üåê –£ –≤–∞—Å ${snapshot.size} –Ω–æ–≤—ã—Ö –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–µ–π!`);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π:', error);
            }
        }
        
        async function markOnlineAsViewed() {
            try {
                // –ü–æ–º–µ—á–∞–µ–º –≤—Å–µ –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏ –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ
                const snapshot = await db.collection('appointments')
                    .where('type', '==', 'client')
                    .where('admin_viewed', '==', false)
                    .get();
                
                const batch = db.batch();
                
                snapshot.forEach(doc => {
                    batch.update(doc.ref, { admin_viewed: true });
                });
                
                if (!snapshot.empty) {
                    await batch.commit();
                    console.log('–û–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
            }
        }
        
        // ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
        function formatPhone(phone) {
            if (!phone) return '–ù–µ —É–∫–∞–∑–∞–Ω';
            if (phone.length === 11) {
                return `+${phone[0]} (${phone.substring(1, 4)}) ${phone.substring(4, 7)}-${phone.substring(7, 9)}-${phone.substring(9, 11)}`;
            }
            return phone;
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showAlert(message, type) {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertsDiv.prepend(alert);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }
        
        function showNotification(message) {
            // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = document.createElement('div');
            notification.className = 'alert alert-info alert-dismissible fade show';
            notification.innerHTML = `
                <strong>${message}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.container').prepend(notification);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }
        
        function logout() {
            if (confirm('–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                });
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                loadAppointments();
            }
        }, 30000);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–ø–∏—Å–∏ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                loadAppointments();
            }
        });
    </script>
</body>
</html>